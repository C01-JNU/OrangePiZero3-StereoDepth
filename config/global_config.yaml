# ============================================================================
# OrangePiZero3-StereoDepth 全局配置文件（CPU版）
# 最后更新: 2026年2月18日
# 作者: C01-JNU & AI助手
# 说明：仅保留CPU立体匹配模块（SGBM/BM），所有参数均从配置文件读取。
#      修改后需重新编译，无运行时热重载。
# ============================================================================

# ----------------------------------------------------------------------------
# 1. 系统配置
# ----------------------------------------------------------------------------
system:
  # 运行模式：仅支持 "cpu"（GPU模式已移除）
  mode: "cpu"

  # 调试日志级别
  # 0: TRACE   - 最详细，仅用于开发
  # 1: DEBUG   - 调试信息
  # 2: INFO    - 常规信息（推荐）
  # 3: WARN    - 警告
  # 4: ERROR   - 错误
  # 5: CRITICAL- 严重错误
  debug_level: 2

  # 是否将日志写入文件
  log_to_file: false
  # 日志文件路径（当 log_to_file 为 true 时有效）
  log_file_path: "logs/stereo_depth.log"

# ----------------------------------------------------------------------------
# 2. 摄像头与图像基础配置
# ----------------------------------------------------------------------------
camera:
  # 原始拼接图像宽度（像素），左右图像已拼接成一张图
  # 默认: 640（单眼宽度 = 320）
  width: 640

  # 原始拼接图像高度（像素）
  # 默认: 480
  height: 480

  # 摄像头目标帧率（摄像头流，用于定时器周期）
  fps: 30

# ----------------------------------------------------------------------------
# 3. 立体匹配算法参数（CPU模式）
# ----------------------------------------------------------------------------
stereo:
  # ---------- 核心算法选择 ----------
  # 算法名称: "sgbm" 或 "bm"
  algorithm: "sgbm"

  # ---------- 通用参数 ----------
  # 最大视差搜索范围
  disparity_range: 64

  # 最小视差（通常为0）
  min_disparity: 0

  # 唯一性比率（%），仅用于SGBM（在WTA时使用）
  # 若 (第二小代价 / 最小代价) < (1 + uniqueness_ratio/100)，则标记为无效
  uniqueness_ratio: 15

  # 中值滤波器尺寸（必须为奇数），后处理中应用
  median_filter_size: 3

  # ---------- SGBM 特定参数 ----------
  sgbm:
    # 窗口大小（blockSize），必须为奇数
    block_size: 7

    # P1 惩罚参数（小视差变化）
    p1: 8.0

    # P2 惩罚参数（大视差变化）
    p2: 32.0

    # 视差窗口模式：true 为左右都检查（推荐）
    mode: true

  # ---------- BM 特定参数 ----------
  bm:
    # 窗口大小（blockSize），必须为奇数
    block_size: 7

    # 预处理滤波类型（0: 无, 1: 归一化响应, 2: Sobel）
    pre_filter_type: 1

    # 预处理滤波大小
    pre_filter_size: 9

    # 预处理滤波上限
    pre_filter_cap: 31

    # 纹理阈值
    texture_threshold: 10

    # 唯一性比率（%），与SGBM类似
    uniqueness_ratio: 15

    # 平滑窗口大小
    speckle_window_size: 100

    # 平滑视差差阈值
    speckle_range: 32

    # 是否尝试小视差
    try_small_disp: false

# ----------------------------------------------------------------------------
# 4. 相机标定配置（用于立体校正和标定程序）
# ----------------------------------------------------------------------------
calibration:
  # 是否使用标定参数进行立体校正
  rectify_images: true

  # 标定结果文件路径（YAML格式）
  calibration_file: "calibration_results/stereo_calibration.yml"

  # 棋盘格内角点数（宽方向）
  board_width: 9

  # 棋盘格内角点数（高方向）
  board_height: 6

  # 棋盘格方块边长（米），根据实际标定板调整（例如 15mm = 0.015m）
  square_size: 0.015

# ----------------------------------------------------------------------------
# 5. 性能与输出配置
# ----------------------------------------------------------------------------
performance:
  # 目标帧率（处理定时器周期）
  target_fps: 10

  # 是否在日志中记录FPS
  log_fps: true

output:
  # 是否保存视差图（PNG格式）
  save_disparity: true

  # 输出目录（相对于可执行文件）
  output_dir: "images/output"

  # 测试图像目录（用于独立程序）
  test_image_dir: "images/test"

# ----------------------------------------------------------------------------
# 6. ROS2 集成配置
# ----------------------------------------------------------------------------
ros2:
  # 是否启用ROS2节点
  enabled: true

  # 节点名称
  node_name: "stereo_depth_node"

  # 命名空间
  namespace: "stereo"

  # 话题名称
  topics:
    left_image:   "/camera/left/image_raw"
    right_image:  "/camera/right/image_raw"
    disparity:    "/stereo/disparity"

  # QoS配置
  qos_depth: 10
  qos_reliability: "best_effort"   # 可选: best_effort, reliable
